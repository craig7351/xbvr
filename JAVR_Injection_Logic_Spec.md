# JAVR 檔名匹配增強邏輯技術規格 (AI Agent 參考手冊)

本文件詳述了針對日本 VR 影片 (JAVR) 的檔名匹配強化方案，包含「雙重注入」、「多變體轉換」以及「批次處理」邏輯。此規格適用於需要將抓取的場景資料與本地檔案進行自動關聯的系統。

---

## 1. 核心概念：雙重注入 (Double Injection)

為了確保匹配成功，系統必須同時引用兩個來源的識別碼作為注入基礎：

1.  **SceneID (抓取站標章)**：由爬蟲從來源網站（如 R18.dev, JavDB）獲獲取的內部唯一 ID。
2.  **QueryID (用戶原始搜尋詞)**：使用者在介面輸入的原始字串（如 `SAVR-883`）。

> **為什麼需要 Double Injection？**
> 有些網站內部存放的 ID（如 `84vrkm00139`）與使用者直覺搜尋的編號（如 `VRKM-139`）不一致。同時對兩者進行規則轉換，可以極大提升匹配率。

---

## 2. 檔名轉換規則 (The Rules)

對於上述的每個 ID 基礎，系統會自動生成以下變體並存入場景的 `Filenames` 清單中：

### A. 基礎四法 (The Core 4)
| 規則名稱 | 邏輯描述 | 範例 (輸入: `SAVR-883`) |
| :--- | :--- | :--- |
| **原始格式** | 保留輸入的原始樣貌 | `SAVR-883` |
| **移除橫線** | 移除所有 `-` 符號 | `SAVR883` |
| **全小寫原始** | 轉換為全小寫字元 | `savr-883` |
| **全小寫去橫線** | 先全小寫再移除橫線 | `savr883` |

### B. JAVR 特等補零規則 (Zero-Padding)
針對 JAVR 特有的 5 位數補零習慣，若 ID 包含內容橫線 `-` 且結尾為數字：

*   **邏輯**：將橫線後的數字部分補滿至 **5 位數**，並與前綴合併。
*   **範例**：`SAVR-883` -> `SAVR00883` 與 `savr00883`。
*   **優效性**：解決了網路上常見將 `ABC-123` 標記為 `abc00123` 之類流傳格式的自動匹配問題。

---

## 3. 批次匯入邏輯 (Batch Processing)

系統應支援在單一輸入框中接收多個 ID，簡化使用者操作。

*   **分隔符號**：使用英文半型逗號 `,` 進行分隔。
*   **處理流程**：
    1.  接收字串（例：`SAVR-001,SAVR-002`）。
    2.  以 `,` 為界線進行 Split，並去除前後空白。
    3.  進入迴圈，對每個 ID 啟動上述的 **Double Injection** 與 **轉換規則**。
    4.  在單次資料庫鎖定期間完成所有處理，提升執行效率。

---

## 4. 實作細節參考 (Go 語言範例)

### 補零轉換代碼邏輯
```go
// 假設輸入為 "SAVR-883"
if strings.Contains(id, "-") {
    parts := strings.Split(id, "-")
    prefix := strings.Join(parts[:len(parts)-1], "") // SAVR
    numPart := parts[len(parts)-1]                    // 883
    if num, err := strconv.Atoi(numPart); err == nil {
        padded := fmt.Sprintf("%s%05d", prefix, num) // SAVR00883
        // 加入候選名單...
    }
}
```

---

## 5. 給 AI Agent 的整合建議
1.  **入口點**：將此邏輯建構於「資料存入資料庫」之前的 `Populate` 或 `BeforeSave` 階段，確保任何來源（包含手動修改）的場景資料都會被自動強化。
2.  **去重處理**：在將轉換後的變體加入清單前，務必進行 `unique` 檢查，避免重複數據佔用資料庫空間。
3.  **UI 提示**：在匯入介面上提供範例（如：`ID (xxxx-001, xxxx-002)`），引導使用者利用批次功能。
